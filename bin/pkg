#!/bin/bash

#PACKAGE_MANAGER=pacman
#PACKAGE_MANAGER=yaourt
if [[ -z $PACKAGE_MANAGER ]]; then
    if which yaourt &>/dev/null; then
        PACKAGE_MANAGER=yaourt
    else
        PACKAGE_MANAGER=pacman
    fi
fi
_pkg_search_binary() {
    pkgfile -srv '\/s?bin\/'$1'$'
}
_pkg_install_binary() {
    local bin_name=$1
    local packages=()
    local fields
    local i n
    local user_choice

    packages=($(pkgfile -sr '\/s?bin\/'$bin_name'$'))
    n=${#packages[@]}

    if ((n > 1)); then
        for ((i=0;i<n;i++)); do
            echo "$((i+1))) ${packages[i]}"
        done

        read -p "[1-$n]? " user_choice || return 1
        let user_choice-=1
        
        if [[ -z ${packages[user_choice]} ]]; then
            echo "Invalid choice" >&2
            return 1
        fi
    elif ((n == 0)); then
        echo "No binary file named $bin_name" >&2
        return 1
    else
        user_choice=0
        read -p "Install ${packages[user_choice]}? [y/N]" -n1
        if [ "$REPLY" != y ] && [ "$REPLY" != Y ]; then
            return 1
        fi
    fi
    pkg install ${packages[user_choice]}
}
_pkg_install_package() {
    local arg_confirm="--noconfirm"
    local arg_needed="--needed"
    local extra_args=()
    local args=`getopt -o'-ifvNh' --long inactive,force,verbose,no-needed,help -n 'pkg' -- "$@"`
    eval set -- "$args"

    while true ; do
      case "$1" in
        -i|--inactive) arg_confirm="" ; shift ;;
        -N|--no-needed) arg_needed="" ; shift ;;
        -f|--force) extra_args+=( "--force" ) ; shift ;;
        -v|--verbose) extra_args+=( "--verbose" ) ; shift ;;
        -h|--help) echo "usage:  pkg i[nstall] [option] package
options:
  -i, --inactive       confirm before install packages
  -N, --no-needed      reinstall up to date packages
  -f, --force          force install, overwrite conflicting files
  -v, --verbose        be verbose
  -h, --help           show this message
"
        $PACKAGE_MANAGER -S --help
        return 0
        ;;
        --) shift ; break ;;
        *) break ;;
      esac
    done
    if [[ $PACKAGE_MANAGER == 'yaourt' ]]; then
        $PACKAGE_MANAGER -S $arg_confirm $arg_needed ${extra_args[@]} $@
    else
        sudo $PACKAGE_MANAGER -S $arg_confirm $arg_needed ${extra_args[@]} $@
    fi
}
_pkg_system_upgrade() {
    sudo -v
    read -N 1 -p "Are you sure upgrade the system? 
Warning: The $PACKAGE_MANAGER cache will be erased, regardless upgrade successful or not.
(y/N)"
    if [[ $REPLY == 'y' ]] || [[ $REPLY == 'Y' ]]; then
        sudo $PACKAGE_MANAGER -S -cc --noconfirm
        sudo $PACKAGE_MANAGER -S -u -yy --force
    else
        return 2
    fi

}

_pkg_list_package() {
    local rc=0
    for pkg ;do
        if $PACKAGE_MANAGER -Qq $pkg 2>/dev/null; then
            $PACKAGE_MANAGER -Ql $pkg
        else
           pkgfile -l $pkg
        fi

        if (( $? != 0 )); then
            let rc++
        fi
    done
}

declare -Ag _pkg_action_map=(
["ui"]="_pkg_system_upgrade"
["iu"]="_pkg_system_upgrade"
["su"]="_pkg_system_upgrade"
["sys"]="_pkg_system_upgrade"
["systemupgrade"]="_pkg_system_upgrade"
["u"]="sudo $PACKAGE_MANAGER -Sy"
["up"]="sudo $PACKAGE_MANAGER -Sy"
["update"]="sudo $PACKAGE_MANAGER -Sy"
["i"]="_pkg_install_package"
["inst"]="_pkg_install_package"
["install"]="_pkg_install_package"
["a"]="_pkg_install_package"
["add"]="_pkg_install_package"
["if"]="$PACKAGE_MANAGER -Si"
["info"]="$PACKAGE_MANAGER -Si"

["r"]="sudo $PACKAGE_MANAGER -Rsc"
["remove"]="sudo $PACKAGE_MANAGER -Rsc"
["un"]="sudo $PACKAGE_MANAGER -Rsc"
["uninstall"]="sudo $PACKAGE_MANAGER -Rsc"

["s"]="$PACKAGE_MANAGER -Ss"
["se"]="$PACKAGE_MANAGER -Ss"
["search"]="$PACKAGE_MANAGER -Ss"

["f"]="pkgfile -srv"
["file"]="pkgfile -srv"
["path"]="pkgfile -srv"
["filename"]="pkgfile -srv"

["binary"]="pkgfile -bsv"
["b"]="_pkg_search_binary"
["bi"]="_pkg_install_binary"
["ib"]="_pkg_install_binary"
["installbinary"]="_pkg_install_binary"

["l"]="_pkg_list_package"
["list"]="_pkg_list_package"
)

pkg() {
    local IFS
    local action=$1
    shift
    if [[ -z $action ]]; then
        echo "Missing action" >&2
        return 1
    fi
    case $action in
        *)
        if [[ -n ${_pkg_action_map[$action]} ]]; then
            IFS=' '
            local cmds=(${_pkg_action_map[$action]})
            IFS=
            ${cmds[@]} $@
        else
            echo "unrecognized action $action" >&2
        fi
        ;;
    esac
}


# if we are executed directly
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && pkg $@
